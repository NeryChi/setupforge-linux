---
# cloudflare/playbook.yml
# Propósito:
# - Aplicar la configuración real del túnel de forma idempotente.
# - Mantener la lógica declarativa en Ansible: instalación de paquetes, archivos y servicio systemd.
#
# Diseño:
# - Nivel de servidor (system-wide): archivos en /etc/cloudflared y servicio en /etc/systemd/system/.
# - Seguridad: la credencial del túnel (<UUID>.json) se guarda con permisos 0600.

- name: Cloudflare Tunnel (system-wide)
  hosts: localhost
  connection: local
  gather_facts: true
  become: true

  vars:
    tunnel_name: "{{ tunnel_name | default(omit) }}"
    hostname: "{{ hostname | default(omit) }}"
    service_url: "{{ service_url | default(omit) }}"
    enable_autostart: "{{ enable_autostart | default(false) | bool }}"
    cloudflared_bin: "{{ cloudflared_bin | default('/usr/bin/cloudflared') }}"
    cloudflared_conf_dir: "{{ cloudflared_conf_dir | default('/etc/cloudflared') }}"
    cloudflared_user: "{{ cloudflared_user | default('cloudflared') }}"
    cloudflared_group: "{{ cloudflared_group | default(cloudflared_user) }}"

  tasks:
    - name: Ensure base packages
      tags: ["install"]
      apt:
        name: [ca-certificates, lsb-release]
        state: present
        update_cache: yes

    - name: Add Cloudflare APT key
      tags: ["install"]
      apt_key:
        url: "https://pkg.cloudflare.com/cloudflare-main.gpg"
        state: present

    - name: Add cloudflared repo
      tags: ["install"]
      apt_repository:
        repo: "deb https://pkg.cloudflare.com/cloudflared {{ ansible_distribution_release }} main"
        filename: "cloudflared"
        state: present

    - name: Install cloudflared
      tags: ["install"]
      apt:
        name: cloudflared
        state: present
        update_cache: yes

    - name: Ensure config dir exists
      tags: ["install","configure"]
      file:
        path: "{{ cloudflared_conf_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Guard required variables
      tags: ["configure"]
      assert:
        that:
          - tunnel_name is defined
          - hostname is defined
          - service_url is defined

    - name: Ensure service user/group exist
      tags: ["configure"]
      user:
        name: "{{ cloudflared_user }}"
        system: true
        shell: /usr/sbin/nologin
        create_home: false

    - name: Check if tunnel exists
      tags: ["configure"]
      command: "{{ cloudflared_bin }} tunnel info {{ tunnel_name }}"
      register: tunnel_info
      changed_when: false
      failed_when: false

    - name: Create tunnel if missing
      tags: ["configure"]
      command: "{{ cloudflared_bin }} tunnel create {{ tunnel_name }}"
      when: tunnel_info.rc != 0
      register: tunnel_create
      changed_when: "'Created tunnel' in (tunnel_create.stdout | default('') + tunnel_create.stderr | default(''))"
      no_log: true

    - name: Resolve tunnel UUID by name
      tags: ["configure"]
      shell: |
        set -euo pipefail
        {{ cloudflared_bin }} tunnel list | awk -v name="{{ tunnel_name }}" 'NR>1 && $NF==name {print $1; exit}'
      args: {executable: /bin/bash}
      register: tunnel_id_cmd
      changed_when: false

    - name: Assert tunnel UUID found
      tags: ["configure"]
      assert:
        that:
          - tunnel_id_cmd.stdout is match("^[0-9a-fA-F-]+$")
        fail_msg: "No se pudo resolver el UUID del túnel '{{ tunnel_name }}'."

    - name: Install tunnel credentials (secure perms)
      tags: ["configure"]
      copy:
        src: "/root/.cloudflared/{{ tunnel_id_cmd.stdout }}.json"
        dest: "{{ cloudflared_conf_dir }}/{{ tunnel_id_cmd.stdout }}.json"
        owner: "{{ cloudflared_user }}"
        group: "{{ cloudflared_group }}"
        mode: "0600"
        remote_src: true

    - name: Render config.yml
      tags: ["configure"]
      template:
        src: "files/config.yml.j2"
        dest: "{{ cloudflared_conf_dir }}/config.yml"
        owner: root
        group: root
        mode: "0644"
      vars:
        tunnel_id: "{{ tunnel_id_cmd.stdout }}"
        cfg_hostname: "{{ hostname }}"
        cfg_service_url: "{{ service_url }}"
        cloudflared_conf_dir: "{{ cloudflared_conf_dir }}"

    - name: Install systemd unit
      tags: ["configure"]
      template:
        src: "files/cloudflared.service.j2"
        dest: "/etc/systemd/system/cloudflared.service"
        owner: root
        group: root
        mode: "0644"
      vars:
        cloudflared_bin: "{{ cloudflared_bin }}"
        cloudflared_conf_dir: "{{ cloudflared_conf_dir }}"
        cloudflared_user: "{{ cloudflared_user }}"
        cloudflared_group: "{{ cloudflared_group }}"

    - name: Reload systemd
      tags: ["configure"]
      systemd:
        daemon_reload: true

    - name: Enable service on boot if requested
      tags: ["configure"]
      systemd:
        name: cloudflared
        enabled: true
      when: enable_autostart

    - name: Start/restart service
      tags: ["configure"]
      systemd:
        name: cloudflared
        state: restarted

    - name: Ensure DNS route
      tags: ["configure"]
      command: "{{ cloudflared_bin }} tunnel route dns {{ tunnel_name }} {{ hostname }}"
      register: dns_route
      changed_when: "'already exists' not in (dns_route.stdout | default('')) and 'already exists' not in (dns_route.stderr | default(''))"
      failed_when: "dns_route.rc != 0 and ('already exists' not in (dns_route.stdout | default('')) and 'already exists' not in (dns_route.stderr | default('')))"