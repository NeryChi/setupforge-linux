---
# cloudflare_tunnel/playbook.yml
# Propósito:
# - Instalar cloudflared usando el paquete .deb oficial (sin repos APT) de forma idempotente.
# - Configurar el túnel a nivel de sistema (system-wide) con servicio systemd de mínimo privilegio.
#
# Diseño:
# - La descarga usa el canal "latest" de GitHub Releases y selecciona el .deb según arquitectura.
# - La instalación se realiza con apt (parámetro deb), que resuelve dependencias si faltan.
# - No se configuran repositorios APT ni se instalan llaves.
#
# Variables relevantes (pueden sobreescribirse vía --extra-vars):
# - tunnel_name, hostname, service_url, enable_autostart
# - cloudflared_bin (ruta al binario), cloudflared_conf_dir
# - cloudflared_user, cloudflared_group

- name: Cloudflare Tunnel (system-wide)
  hosts: localhost
  connection: local
  gather_facts: true
  become: true

  vars:
    # Entradas principales
    tunnel_name: "{{ tunnel_name | default(omit) }}"
    hostname: "{{ hostname | default(omit) }}"
    service_url: "{{ service_url | default(omit) }}"
    enable_autostart: "{{ enable_autostart | default(false) | bool }}"

    # Rutas y usuario/grupo del servicio
    cloudflared_bin: "{{ cloudflared_bin | default('/usr/bin/cloudflared') }}"
    cloudflared_conf_dir: "{{ cloudflared_conf_dir | default('/etc/cloudflared') }}"
    cloudflared_user: "{{ cloudflared_user | default('cloudflared') }}"
    cloudflared_group: "{{ cloudflared_group | default(cloudflared_user) }}"

    # Descarga del paquete .deb (mapeo de arquitecturas)
    _deb_arch_map:
      x86_64: amd64
      amd64: amd64
      aarch64: arm64
      arm64: arm64
      armv7l: armhf
      armhf: armhf

  tasks:
    # ------------------- Fase INSTALL (sin repos APT) -------------------
    - name: Ensure base packages present (APT resolver y utilidades)
      tags: ["install"]
      apt:
        name:
          - ca-certificates
          - apt-transport-https
        state: present
        update_cache: yes

    - name: Resolve deb architecture from ansible_architecture
      tags: ["install"]
      set_fact:
        deb_arch: "{{ _deb_arch_map.get(ansible_architecture, 'amd64') }}"

    - name: Compose download URL for cloudflared .deb (latest release)
      tags: ["install"]
      set_fact:
        cloudflared_deb_url: "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-{{ deb_arch }}.deb"
        cloudflared_deb_path: "/tmp/cloudflared-linux-{{ deb_arch }}.deb"

    - name: Download cloudflared .deb for {{ deb_arch }}
      tags: ["install"]
      get_url:
        url: "{{ cloudflared_deb_url }}"
        dest: "{{ cloudflared_deb_path }}"
        mode: "0644"
        # Si el archivo ya existe con el mismo tamaño/ETag, no marca cambio
        force: false
        timeout: 60
      register: deb_download

    - name: Install cloudflared from local .deb via apt
      tags: ["install"]
      apt:
        deb: "{{ cloudflared_deb_path }}"
        state: present
      register: deb_installed

    - name: Ensure {{ cloudflared_conf_dir }} exists
      tags: ["install","configure"]
      file:
        path: "{{ cloudflared_conf_dir }}"
        state: directory
        owner: root
        group: root
        mode: "0755"

    # ------------------- Fase CONFIGURE -------------------
    - name: Guard required variables
      tags: ["configure"]
      assert:
        that:
          - tunnel_name is defined
          - hostname is defined
          - service_url is defined
        fail_msg: "Faltan variables requeridas: tunnel_name, hostname, service_url."

    - name: Ensure service user/group exist (least privilege)
      tags: ["configure"]
      user:
        name: "{{ cloudflared_user }}"
        system: true
        shell: /usr/sbin/nologin
        create_home: false

    - name: Check if tunnel exists
      tags: ["configure"]
      command: "{{ cloudflared_bin }} tunnel info {{ tunnel_name }}"
      register: tunnel_info
      changed_when: false
      failed_when: false

    - name: Create tunnel if missing
      tags: ["configure"]
      command: "{{ cloudflared_bin }} tunnel create {{ tunnel_name }}"
      when: tunnel_info.rc != 0
      register: tunnel_create
      changed_when: "'Created tunnel' in ((tunnel_create.stdout | default('')) + (tunnel_create.stderr | default('')))"
      no_log: true

    - name: Resolve tunnel UUID by name
      tags: ["configure"]
      shell: |
        set -euo pipefail
        {{ cloudflared_bin }} tunnel list | awk -v name="{{ tunnel_name }}" 'NR>1 && $NF==name {print $1; exit}'
      args:
        executable: /bin/bash
      register: tunnel_id_cmd
      changed_when: false

    - name: Assert tunnel UUID found
      tags: ["configure"]
      assert:
        that:
          - tunnel_id_cmd.stdout is match("^[0-9a-fA-F-]+$")
        fail_msg: "No se pudo resolver el UUID del túnel '{{ tunnel_name }}'. Ejecuta primero 'cloudflared tunnel login' en este host."

    - name: Install tunnel credentials into {{ cloudflared_conf_dir }} (secure)
      tags: ["configure"]
      copy:
        src: "/root/.cloudflared/{{ tunnel_id_cmd.stdout }}.json"
        dest: "{{ cloudflared_conf_dir }}/{{ tunnel_id_cmd.stdout }}.json"
        owner: "{{ cloudflared_user }}"
        group: "{{ cloudflared_group }}"
        mode: "0600"
        remote_src: true

    - name: Render {{ cloudflared_conf_dir }}/config.yml
      tags: ["configure"]
      template:
        src: "files/config.yml.j2"
        dest: "{{ cloudflared_conf_dir }}/config.yml"
        owner: root
        group: root
        mode: "0644"
      vars:
        tunnel_id: "{{ tunnel_id_cmd.stdout }}"
        cfg_hostname: "{{ hostname }}"
        cfg_service_url: "{{ service_url }}"
        cloudflared_conf_dir: "{{ cloudflared_conf_dir }}"

    - name: Install systemd unit for cloudflared
      tags: ["configure"]
      template:
        src: "files/cloudflared.service.j2"
        dest: "/etc/systemd/system/cloudflared.service"
        owner: root
        group: root
        mode: "0644"
      vars:
        cloudflared_bin: "{{ cloudflared_bin }}"
        cloudflared_conf_dir: "{{ cloudflared_conf_dir }}"
        cloudflared_user: "{{ cloudflared_user }}"
        cloudflared_group: "{{ cloudflared_group }}"

    - name: Reload systemd daemon
      tags: ["configure"]
      systemd:
        daemon_reload: true

    - name: Enable service on boot if requested
      tags: ["configure"]
      systemd:
        name: cloudflared
        enabled: true
      when: enable_autostart

    - name: Start (or restart) cloudflared service now
      tags: ["configure"]
      systemd:
        name: cloudflared
        state: restarted

    - name: Create/ensure DNS route for the tunnel
      tags: ["configure"]
      command: "{{ cloudflared_bin }} tunnel route dns {{ tunnel_name }} {{ hostname }}"
      register: dns_route
      changed_when: "'already exists' not in ((dns_route.stdout | default('')) + (dns_route.stderr | default('')))"
      failed_when: "dns_route.rc != 0 and ('already exists' not in ((dns_route.stdout | default('')) + (dns_route.stderr | default(''))))"